rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

  // 앱 설정/버전 정보는 누구나 읽기 가능 (로그인 전 체크를 위해)
      match /config/{document=**} {
        allow read: if true;
        allow write: if false; // 쓰기는 관리자만(콘솔에서) 가능
      }

  // 차단된 사용자인지 확인하는 함수
      function isBanned() {
        // 사용자 문서의 status 필드가 'banned'이면 true 반환
        // (request.auth.uid가 null이 아닐 때만 체크)
        return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'banned';
      }

      // 접근 허용 조건: 인증됨 AND 차단되지 않음
      function isAuthenticatedAndNotBanned() {
        return request.auth != null && !isBanned();
      }

      // 기존 규칙들을 isAuthenticatedAndNotBanned()를 사용하여 강화

      // 사용자 컬렉션
      match /users/{userId} {
        allow create: if request.auth != null && request.auth.uid == userId;
        // [수정] 차단된 유저는 본인 정보 수정/삭제 불가, 읽기도 불가
        allow read, update, delete: if isAuthenticatedAndNotBanned() && request.auth.uid == userId;
        // [수정] 다른 유저 정보 읽기도 차단된 유저는 불가
        allow read: if isAuthenticatedAndNotBanned();

        match /blocked_users/{blockedUserId} {
          allow read, write: if isAuthenticatedAndNotBanned() && request.auth.uid == userId;
        }
      }

      // 그룹 컬렉션
      match /groups/{groupId} {
        allow create: if isAuthenticatedAndNotBanned() && request.auth.uid == request.resource.data.ownerId;
        allow read: if isAuthenticatedAndNotBanned();
        // ... 나머지 규칙들도 request.auth != null 대신 isAuthenticatedAndNotBanned() 사용 권장
      }

      // 채팅방, 메시지, 초대장 등 다른 모든 컬렉션에도 동일하게 적용
      // 예:
      match /messages/{messageId} {
        allow create: if isAuthenticatedAndNotBanned() && request.auth.uid == request.resource.data.senderId;
        allow read: if isAuthenticatedAndNotBanned();
        allow update, delete: if isAuthenticatedAndNotBanned() && request.auth.uid == resource.data.senderId;
      }

    // 기본 규칙: 인증되지 않은 접근 차단
    match /{document=**} {
      allow read, write: if false;
    }

    // 사용자 컬렉션
    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
      // 다른 유저 정보 읽기 허용 (프로필 조회 등)
      allow read: if request.auth != null;

      // 차단 목록 서브 컬렉션 (내 차단 목록은 나만 관리)
      match /blocked_users/{blockedUserId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // 그룹 컬렉션
    match /groups/{groupId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.ownerId;
      allow read: if request.auth != null;
      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerId;
      allow update: if request.auth != null && (
        request.auth.uid in resource.data.memberIds ||
        (
          !(request.auth.uid in resource.data.memberIds) &&
          request.resource.data.memberIds == resource.data.memberIds.concat([request.auth.uid]) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberIds', 'updatedAt'])
        )
      );
    }

    // 채팅방 컬렉션
    match /chatrooms/{chatroomId} {
      allow read, write, update: if request.auth != null && (
        (resource != null && request.auth.uid in resource.data.participants) ||
        (exists(/databases/$(database)/documents/groups/$(chatroomId)) &&
         request.auth.uid in get(/databases/$(database)/documents/groups/$(chatroomId)).data.memberIds)
      );
      allow create: if request.auth != null && (
         exists(/databases/$(database)/documents/groups/$(chatroomId)) &&
         request.auth.uid in get(/databases/$(database)/documents/groups/$(chatroomId)).data.memberIds
      );
    }

    // 오픈 채팅방 컬렉션
    match /openChatrooms/{chatroomId} {
      // 읽기: 모든 인증된 사용자가 활성 채팅방 조회 가능
      allow read: if request.auth != null;
      // 생성: 인증된 사용자가 본인을 생성자로 하는 채팅방 생성 가능
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.creatorId &&
                       request.resource.data.participants.hasOnly([request.auth.uid]) &&
                       request.resource.data.participantCount == 1;
      // 업데이트: 참가자 추가 (조인), 메시지 전송, 또는 생성자가 업데이트
      allow update: if request.auth != null && (
        // 참가자 추가 (본인을 participants에 추가)
        (request.auth.uid in request.resource.data.participants &&
         !(request.auth.uid in resource.data.participants) &&
         request.resource.data.participants.size() == resource.data.participants.size() + 1 &&
         request.resource.data.participantCount == resource.data.participantCount + 1) ||
        // 참가자가 메시지 전송 (messages 배열에 추가)
        (request.auth.uid in resource.data.participants) ||
        // 생성자가 채팅방 정보 수정
        (request.auth.uid == resource.data.creatorId)
      );
      // 삭제: 생성자만 가능
      allow delete: if request.auth != null && request.auth.uid == resource.data.creatorId;
    }

    // 메시지 컬렉션
    match /messages/{messageId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.senderId;
      allow read: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.senderId;
    }

    // 초대장 컬렉션
    match /invitations/{invitationId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.fromUserId;
      allow read: if request.auth != null && (request.auth.uid == resource.data.fromUserId || request.auth.uid == resource.data.toUserId);
      allow update: if request.auth != null && request.auth.uid == resource.data.toUserId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.fromUserId;
    }

    // 닉네임 선점 규칙 (좀비 데이터 정리 허용)
    match /nicknames/{nickname} {
      allow read: if request.auth != null;
      // 생성은 누구나 가능 (단, 앱 로직에서 중복 체크)
      allow create: if request.auth != null;
      // 삭제/수정 조건: 내 것이거나 OR 연결된 유저(uid)가 DB에 없으면(좀비) 삭제 가능
      allow update, delete: if request.auth != null && (
        request.auth.uid == resource.data.uid ||
        !exists(/databases/$(database)/documents/users/$(resource.data.uid))
      );
    }

    // 전화번호 선점 규칙 (좀비 데이터 정리 허용)
    match /phoneNumbers/{phoneNumber} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      // 삭제/수정 조건: 내 것이거나 OR 연결된 유저(uid)가 DB에 없으면(좀비) 삭제 가능
      allow update, delete: if request.auth != null && (
        request.auth.uid == resource.data.uid ||
        !exists(/databases/$(database)/documents/users/$(resource.data.uid))
      );
    }

    // 차단 관리 컬렉션 (쌍방 차단용)
        // ID 형식: "차단한UID_차단당한UID"
        match /blocks/{blockId} {
          // 생성: 본인이 차단하는 경우만 허용
          allow create: if request.auth != null && request.auth.uid == request.resource.data.blockerId;
          // 읽기: 차단한 사람(blocker)과 차단당한 사람(blocked) 모두 읽기 가능
          allow read: if request.auth != null && (
            request.auth.uid == resource.data.blockerId ||
            request.auth.uid == resource.data.blockedId
          );
          // 삭제(차단 해제): 차단한 사람만 가능
          allow delete: if request.auth != null && request.auth.uid == resource.data.blockerId;
        }

    // 신고 컬렉션 (누구나 생성 가능)
    match /reports/{reportId} {
      allow create: if request.auth != null;
    }

    // 매칭 제외 컬렉션 (ID 형식: "제외한UID_제외된UID")
    match /matchExemptions/{exemptId} {
      // 생성: 본인이 제외하는 경우만 허용
      allow create: if request.auth != null && request.auth.uid == request.resource.data.exempterId;
      // 읽기: 제외한 사람과 제외당한 사람 모두 읽기 가능
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.exempterId ||
        request.auth.uid == resource.data.exemptedId
      );
      // 수정: 제외한 사람만 가능 (set() 호출 시 필요)
      allow update: if request.auth != null && request.auth.uid == resource.data.exempterId;
      // 삭제(제외 해제): 제외한 사람만 가능
      allow delete: if request.auth != null && request.auth.uid == resource.data.exempterId;
    }

    // 평점 컬렉션 (ID 형식: "평가자UID_평가받는UID")
    match /ratings/{ratingId} {
      // 생성: 본인이 다른 사용자를 평가하는 경우만 허용 (자기 자신은 평가 불가)
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.raterId &&
                       request.auth.uid != request.resource.data.ratedUserId;
      // 읽기: 모든 인증된 사용자가 평점 읽기 가능 (평균 계산 등을 위해)
      allow read: if request.auth != null;
      // 수정: 자신이 남긴 평점만 수정 가능 (set with merge 허용)
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.raterId &&
                       request.auth.uid == request.resource.data.raterId;
      // 삭제: 자신이 남긴 평점만 삭제 가능
      allow delete: if request.auth != null && request.auth.uid == resource.data.raterId;
    }
  }
}